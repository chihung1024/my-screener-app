<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>全端量化篩選平台 (Python 後端)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        .title-font {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .table-header {
            background-color: #f8fafc;
        }
        .rank-highlight {
            background-color: #e0f2fe; /* Light blue */
            color: #0c4a6e; /* Dark blue */
        }
        .loader {
            border: 8px solid #f3f3f3;
            border-radius: 50%;
            border-top: 8px solid #3b82f6;
            width: 60px;
            height: 60px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .tooltip {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 280px;
            background-color: #374151;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.5;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 title-font">全端量化篩選平台</h1>
            <p class="mt-2 text-gray-600">由 Python (Flask + yfinance) 後端驅動</p>
        </div>

        <!-- Setup Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="card p-6">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold text-gray-800 title-font">第一步：定義候選股票池</h2>
                    <button id="loadSP500" class="bg-green-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-300 text-sm">
                        載入預設 S&P 500 列表
                    </button>
                </div>
                <textarea id="stockPool" class="w-full h-24 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="點擊右上方按鈕載入 S&P 500，或手動輸入..."></textarea>
                <p class="text-xs text-gray-500 mt-2">後端使用 yfinance，處理大量股票可能需要較長時間，請耐心等候。</p>
            </div>
            <div class="card p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800 title-font">第二步：調整因子權重</h2>
                    <div class="text-right">
                        <span class="font-bold text-lg">總權重:</span>
                        <span id="totalWeight" class="font-bold text-lg text-green-600">100%</span>
                    </div>
                </div>
                <div id="weightsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-8 gap-y-4">
                    <!-- Weight sliders will be generated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Run Button -->
        <div class="text-center mb-8">
            <button id="runScreener" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 text-lg">
                執行量化篩選
            </button>
        </div>

        <!-- Results Section -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800 title-font">量化篩選結果</h2>
                 <div class="flex items-center gap-4">
                    <div id="lastUpdated" class="text-sm text-gray-500"></div>
                    <button id="exportCsv" class="hidden bg-gray-700 text-white font-bold py-1 px-3 rounded-lg hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition duration-300 text-sm">
                        匯出為 CSV
                    </button>
                 </div>
            </div>
            <div id="loaderContainer" class="text-center py-10 hidden">
                <div class="loader inline-block"></div>
                <p id="loaderText" class="mt-4 text-gray-600 font-semibold">正在向後端發送請求，請稍候...</p>
            </div>
            <div id="resultsContainer" class="card overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-500">
                    <thead id="resultsHeader" class="text-xs text-gray-700 uppercase table-header">
                        <!-- Header will be generated by JS -->
                    </thead>
                    <tbody id="screener-results"></tbody>
                </table>
                 <div id="noResults" class="p-8 text-center text-gray-500">
                    <p>請定義股票池並點擊「執行量化篩選」。</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for errors -->
    <div id="errorModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-red-600 mb-4">發生錯誤</h3>
            <p id="modalErrorMessage" class="text-gray-700 mb-6"></p>
            <button id="closeModal" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">關閉</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DOM Elements ---
        const runScreenerBtn = document.getElementById('runScreener');
        const stockPoolInput = document.getElementById('stockPool');
        const resultsBody = document.getElementById('screener-results');
        const resultsHeader = document.getElementById('resultsHeader');
        const loader = document.getElementById('loaderContainer');
        const loaderText = document.getElementById('loaderText');
        const resultsContainer = document.getElementById('resultsContainer');
        const noResultsMessage = document.getElementById('noResults');
        const lastUpdatedEl = document.getElementById('lastUpdated');
        const loadSP500Btn = document.getElementById('loadSP500');
        const errorModal = document.getElementById('errorModal');
        const modalErrorMessage = document.getElementById('modalErrorMessage');
        const closeModalBtn = document.getElementById('closeModal');
        const weightsContainer = document.getElementById('weightsContainer');
        const totalWeightEl = document.getElementById('totalWeight');
        const exportCsvBtn = document.getElementById('exportCsv');
        
        let rankedStocksData = []; // To store results for CSV export

        // --- Factor Definitions (must match backend) ---
        const factors = [
            { id: 'ROIC', name: 'ROIC', higherIsBetter: true, defaultWeight: 30 },
            { id: '研發/銷售', name: '研發/銷售', higherIsBetter: true, defaultWeight: 25 },
            { id: '淨債務/EBITDA', name: '淨債務/EBITDA', higherIsBetter: false, defaultWeight: 20 },
            { id: 'EV/FCF', name: 'EV/FCF', higherIsBetter: false, defaultWeight: 15 },
            { id: '營收CAGR(3Y)', name: '營收CAGR(3Y)', higherIsBetter: true, defaultWeight: 10 }
        ];

        // --- Initial Setup ---
        function initialize() {
            createWeightSliders();
            loadSettings();
            
            runScreenerBtn.addEventListener('click', runScreener);
            loadSP500Btn.addEventListener('click', loadPresetSP500List);
            closeModalBtn.addEventListener('click', () => errorModal.classList.add('hidden'));
            exportCsvBtn.addEventListener('click', exportToCsv);
        }

        function createWeightSliders() {
            weightsContainer.innerHTML = '';
            factors.forEach(factor => {
                const sliderHtml = `
                    <div class="flex flex-col">
                        <label for="${factor.id}-weight" class="mb-1 text-sm font-medium text-gray-700">${factor.name} (${factor.higherIsBetter ? '越高越好' : '越低越好'})</label>
                        <div class="flex items-center gap-4">
                            <input type="range" id="${factor.id}-weight" data-factorid="${factor.id}" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" min="0" max="100" value="${factor.defaultWeight}">
                            <span id="${factor.id}-value" class="font-semibold text-gray-800 w-12 text-right">${factor.defaultWeight}%</span>
                        </div>
                    </div>
                `;
                weightsContainer.innerHTML += sliderHtml;
            });
            weightsContainer.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.addEventListener('input', updateWeights);
            });
        }

        function updateWeights() {
            let total = 0;
            weightsContainer.querySelectorAll('input[type="range"]').forEach(slider => {
                document.getElementById(`${slider.dataset.factorid}-value`).textContent = `${slider.value}%`;
                total += parseInt(slider.value, 10);
            });
            totalWeightEl.textContent = `${total}%`;
            totalWeightEl.className = total === 100 ? 'font-bold text-lg text-green-600' : 'font-bold text-lg text-red-600 animate-pulse';
        }

        function getWeightsPayload() {
            const payload = {};
            factors.forEach(factor => {
                const slider = document.getElementById(`${factor.id}-weight`);
                payload[factor.id] = {
                    weight: parseInt(slider.value, 10) / 100,
                    higher_is_better: factor.higherIsBetter
                };
            });
            return payload;
        }

        function loadSettings() {
            const savedStockPool = localStorage.getItem('screenerStockPool');
            if (savedStockPool) stockPoolInput.value = savedStockPool;
        }

        function saveSettings() {
            localStorage.setItem('screenerStockPool', stockPoolInput.value.trim());
        }

        // --- Core Logic ---
        function showErrorModal(message) {
            loader.classList.add('hidden');
            modalErrorMessage.textContent = message;
            errorModal.classList.remove('hidden');
        }

        function validateInputs() {
            const total = Object.values(getWeightsPayload()).reduce((sum, f) => sum + f.weight, 0);
            if (Math.round(total * 100) !== 100) {
                showErrorModal('因子總權重必須等於 100%。請調整滑桿。');
                return false;
            }
            return true;
        }

        function loadPresetSP500List() {
            const sp500tickers = [...new Set(['MSFT', 'AAPL', 'NVDA', 'GOOGL', 'GOOG', 'AMZN', 'META', 'BRK.B', 'LLY', 'AVGO', 'JPM', 'V', 'TSLA', 'XOM', 'WMT', 'UNH', 'MA', 'PG', 'JNJ', 'HD', 'COST', 'MRK', 'ABBV', 'CRM', 'BAC', 'CVX', 'NFLX', 'AMD', 'KO', 'PEP', 'ADBE', 'TMO', 'WFC', 'LIN', 'CSCO', 'MCD', 'DIS', 'ACN', 'ABT', 'GE', 'INTC', 'PFE', 'CAT', 'VZ', 'AMAT', 'UBER', 'INTU', 'COP', 'IBM', 'NOW', 'QCOM', 'UNP', 'T', 'AXP', 'SPGI', 'PM', 'LOW', 'TXN', 'RTX', 'HON', 'BA', 'PLD', 'AMGN', 'ORCL', 'MDT', 'NKE', 'SBUX', 'ISRG', 'GS', 'BLK', 'ETN', 'UPS', 'PGR', 'C', 'LRCX', 'NEE', 'SYK', 'BMY', 'ELV', 'SCHW', 'TJX', 'DE', 'VRTX', 'ADP', 'CI', 'REGN', 'MMC', 'SO', 'CVS', 'MDLZ', 'LMT', 'FI', 'BSX', 'AMT', 'ZTS', 'GILD', 'MO', 'ADI', 'CMCSA', 'DUK', 'BDX', 'ICE', 'PYPL', 'PANW', 'SLB', 'EOG', 'CSX', 'AON', 'MPC', 'MAR', 'TGT', 'MU', 'ABNB', 'PSX', 'ORLY', 'CB', 'ETR', 'OXY', 'KLAC', 'EQIX', 'PNC', 'SNPS', 'FCX', 'ROP', 'MCO', 'APH', 'ITW', 'USB', 'GD', 'TRV', 'WM', 'MCK', 'CDNS', 'CL', 'DHR', 'SHW', 'CMG', 'NOC', 'FDX', 'HUM', 'PXD', 'AEP', 'TEL', 'EMR', 'EXC', 'PCAR', 'MSI', 'PAYX', 'PH', 'CNC', 'ADSK', 'SRE', 'CEG', 'NSC', 'RSG', 'ROST', 'JCI', 'KMB', 'KMI', 'MET', 'COR', 'BKNG', 'HAL', 'PRU', 'AIG', 'EA', 'HCA', 'CTAS', 'PCG', 'AFL', 'DVN', 'WELL', 'MS', 'VLO', 'WMB', 'FAST', 'TFC', 'FTNT', 'XEL', 'O', 'BIIB', 'BK', 'CMI', 'D', 'DXCM', 'DLR', 'OKE', 'PPG', 'DG', 'STZ', 'PSA', 'A', 'AJG', 'APD', 'AZO', 'AWK', 'ALLE', 'AME', 'AMP', 'BAX', 'CARR', 'CDW', 'CE', 'CHTR', 'COF', 'CPRT', 'CSGP', 'CTRA', 'CTVA', 'DAL', 'DD', 'DOW', 'DRI', 'ECL', 'ED', 'EFX', 'EIX', 'EL', 'ES', 'ESS', 'EVRG', 'EW', 'FANG', 'FDS', 'FE', 'FFIV', 'FIS', 'FISV', 'FMC', 'FSLR', 'FTV', 'GEHC', 'GIS', 'GLW', 'GM', 'GPN', 'GWW', 'HES', 'HIG', 'HLT', 'HPQ', 'HRL', 'HSY', 'HST', 'HSIC', 'IEX', 'IFF', 'ILMN', 'INCY', 'IP', 'IPG', 'IQV', 'IRM', 'IVZ', 'J', 'JBHT', 'JKHY', 'K', 'KDP', 'KEY', 'KHC', 'KIM', 'KR', 'L', 'LDOS', 'LEN', 'LH', 'LHX', 'LKQ', 'LULU', 'LUV', 'LVS', 'LYB', 'LYV', 'MAS', 'MCHP', 'MGM', 'MHK', 'MLM', 'MNST', 'MOS', 'MPWR', 'MRNA', 'MTB', 'MTD', 'NCLH', 'NDAQ', 'NDSN', 'NEM', 'NI', 'NRG', 'NTRS', 'NUE', 'NVR', 'NXPI', 'ODFL', 'ON', 'OTIS', 'PEG', 'PPL', 'QRVO', 'RCL', 'RF', 'RHI', 'RL', 'RMD', 'ROK', 'ROL', 'RVTY', 'SBAC', 'SNA', 'SPG', 'STE', 'STT', 'STX', 'SWK', 'SWKS', 'SYF', 'SYY', 'TAP', 'TDG', 'TDY', 'TECH', 'TER', 'TFX', 'TROW', 'TRMB', 'TSCO', 'TSN', 'TT', 'TTWO', 'UAL', 'UDR', 'UHS', 'ULTA', 'VFC', 'VICI', 'VMC', 'VRSK', 'VRSN', 'VTR', 'VTRS', 'WAB', 'WAT', 'WBD', 'WDC', 'WEC', 'WHR', 'WST', 'WY', 'WYNN', 'YUM', 'ZBH'])];
            stockPoolInput.value = sp500tickers.join(',');
        }

        async function runScreener() {
            if (!validateInputs()) return;
            saveSettings();

            resultsContainer.classList.add('hidden');
            noResultsMessage.classList.add('hidden');
            exportCsvBtn.classList.add('hidden');
            resultsBody.innerHTML = '';
            lastUpdatedEl.textContent = '';
            
            const tickers = stockPoolInput.value.trim().toUpperCase().split(',').map(t => t.trim()).filter(t => t);
            if (tickers.length === 0) {
                showErrorModal('股票池為空。請載入 S&P 500 或手動輸入股票代碼。');
                return;
            }

            loader.classList.remove('hidden');
            loaderText.textContent = `請求已發送至後端，正在處理 ${tickers.length} 支股票... 這可能需要數分鐘，請耐心等候。`;
            
            const payload = {
                tickers: tickers,
                weights: getWeightsPayload()
            };

            try {
                // The URL '/api/screener' works for local testing and when deployed on Vercel.
                const response = await fetch('/api/screen', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `後端伺服器錯誤 (狀態碼: ${response.status})`);
                }

                const results = await response.json();
                rankedStocksData = results;
                renderTable(results);

            } catch (error) {
                console.error("篩選過程中發生錯誤:", error);
                showErrorModal(`篩選失敗: ${error.message}`);
            } finally {
                loader.classList.add('hidden');
            }
        }
        
        function renderTable(stocks) {
            if (stocks.length === 0) {
                noResultsMessage.classList.remove('hidden');
                return;
            }

            resultsContainer.classList.remove('hidden');
            exportCsvBtn.classList.remove('hidden');
            lastUpdatedEl.textContent = `數據更新於: ${new Date().toLocaleString('zh-TW')}`;

            // Render Header
            let headerHTML = '<tr><th scope="col" class="px-3 py-3">綜合排名</th><th scope="col" class="px-3 py-3">公司</th>';
            factors.forEach(factor => {
                headerHTML += `<th scope="col" class="px-3 py-3">${factor.name}</th>`;
            });
            headerHTML += '<th scope="col" class="px-3 py-3">綜合分</th></tr>';
            resultsHeader.innerHTML = headerHTML;

            // Render Body
            resultsBody.innerHTML = '';
            stocks.forEach((stock, index) => {
                const rank = index + 1;
                const rowClass = rank <= 20 ? 'rank-highlight' : '';

                const formatCell = (value, isPercent=false) => {
                    if (value === null || typeof value === 'undefined') return `<td class="px-3 py-4 text-gray-400">N/A</td>`;
                    return `<td class="px-3 py-4">${isPercent ? (value * 100).toFixed(2) + '%' : value.toFixed(2)}</td>`;
                };
                
                const formatRankCell = (value) => {
                    if (value === null || typeof value === 'undefined') return '';
                    return `<span class="text-xs text-gray-500 ml-1">(${value})</span>`;
                }

                let rowHTML = `<tr class="border-b hover:bg-gray-50 ${rowClass}">
                        <td class="px-3 py-4 font-bold text-lg text-center">${rank}</td>
                        <td class="px-3 py-4">
                            <div class="font-bold text-gray-900">${stock['代碼']}</div>
                            <div class="text-xs text-gray-600">${stock['公司名稱']}</div>
                        </td>`;
                
                factors.forEach(factor => {
                    const value = stock[factor.id];
                    const rankValue = stock[`${factor.id}_排名`];
                    const isPercent = ['ROIC', '研發/銷售', '營收CAGR(3Y)'].includes(factor.id);
                    if (value === null || typeof value === 'undefined') {
                        rowHTML += `<td class="px-3 py-4 text-gray-400">N/A</td>`;
                    } else {
                         rowHTML += `<td class="px-3 py-4">
                                ${isPercent ? (value * 100).toFixed(2) + '%' : value.toFixed(2)}
                                ${formatRankCell(rankValue)}
                            </td>`;
                    }
                });

                rowHTML += `<td class="px-3 py-4 font-bold text-gray-900 text-center">${stock['綜合分'] ? stock['綜合分'].toFixed(2) : 'N/A'}</td></tr>`;
                resultsBody.innerHTML += rowHTML;
            });
        }
        
        function exportToCsv() {
            if (rankedStocksData.length === 0) return;
            
            const headers = ['綜合排名', '代碼', '公司名稱', ...factors.map(f => f.name), ...factors.map(f => `${f.name}排名`), '綜合分'];
            let csvContent = "data:text/csv;charset=utf-8," + headers.join(',') + "\n";

            rankedStocksData.forEach((stock, index) => {
                const rank = index + 1;
                const row = [
                    rank,
                    stock['代碼'],
                    `"${stock['公司名稱'].replace(/"/g, '""')}"`,
                    ...factors.map(f => stock[f.id] !== null ? stock[f.id].toFixed(4) : 'N/A'),
                    ...factors.map(f => stock[`${f.id}_排名`] || 'N/A'),
                    stock['綜合分'] ? stock['綜合分'].toFixed(4) : 'N/A'
                ];
                csvContent += row.join(',') + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `quantitative_screener_results_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Start the App ---
        initialize();
    });
    </script>
</body>
</html>
